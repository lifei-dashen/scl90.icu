<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SCL-90 症状自评量表 | 心理健康评估</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 基础重置与变量定义 --- */
        :root {
            --primary-green: #34C759;
            --light-green: #DDF7E3;
            --dark-green: #2A9D40;
            --text-dark: #1D1D1F;
            --text-light: #86868B;
            --background: #F5F5F7;
            --card-bg: #FFFFFF;
            --border-color: #E5E5E7;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            
            /* 默认桌面端间距 */
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 32px;
            --spacing-xl: 48px;
        }

        /* 手机端间距变量重写 (媒体查询放在这里最有效) */
        @media (max-width: 768px) {
            :root {
                --spacing-md: 16px;
                --spacing-lg: 20px;
                --spacing-xl: 32px;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* 移除移动端点击高亮 */
        }

        body {
            background-color: var(--background);
            color: var(--text-dark);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-sm);
            padding-bottom: 60px; /* 防止移动端底部被遮挡 */
        }

        /* --- 头部样式优化 --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--spacing-lg);
            background-color: var(--background); /* 确保背景一致 */
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background-color: var(--primary-green);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: var(--spacing-lg);
        }

        nav a {
            text-decoration: none;
            color: var(--text-dark);
            font-weight: 500;
            font-size: 15px;
            padding: 8px 0;
            position: relative;
            transition: color 0.2s;
        }

        nav a.active, nav a:hover {
            color: var(--primary-green);
        }

        nav a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-green);
            border-radius: 1px;
        }

        /* --- 主要内容区域 --- */
        main {
            min-height: 70vh;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 首页 Hero --- */
        .hero {
            text-align: center;
            padding: var(--spacing-lg) 0;
        }

        .hero h1 {
            font-size: clamp(28px, 5vw, 48px); /* 响应式字体大小 */
            font-weight: 800;
            margin-bottom: var(--spacing-sm);
            line-height: 1.2;
            color: #000;
        }

        .hero p {
            font-size: clamp(16px, 3vw, 20px);
            color: var(--text-light);
            max-width: 700px;
            margin: 0 auto var(--spacing-lg);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-green);
            color: white;
            padding: 12px 32px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3);
            user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .features {
            display: grid;
            /* 调整最小宽度为 100%，让它在手机上自动单列 */
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .feature-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        /* --- 测试页面 --- */
        .test-header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .progress-container {
            margin: var(--spacing-md) auto;
            max-width: 600px;
        }

        .progress-bar {
            height: 8px;
            background-color: #E0E0E0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-green);
            width: 0%;
            transition: width 0.3s ease-out;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-light);
            font-weight: 500;
        }

        .question-container {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
        }

        .question-number {
            display: inline-block;
            background-color: var(--light-green);
            color: var(--dark-green);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
        }

        .question-text {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
            line-height: 1.4;
        }

        .options-container {
            display: grid;
            /* 手机端每行1个，平板每行2个，大屏每行5个 */
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .option {
            padding: 16px 12px;
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
            /* 增加点击区域 */
            position: relative; 
        }

        /* 移动端触摸反馈 */
        .option:active {
            background-color: #f0f0f0;
        }

        .option.selected {
            border-color: var(--primary-green);
            background-color: var(--light-green);
            color: var(--dark-green);
        }

        .option-value {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
            color: inherit;
        }

        .option.selected .option-value {
             color: var(--dark-green);
        }

        .test-navigation {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: var(--spacing-lg);
        }

        .btn-secondary {
            background-color: white;
            color: var(--text-dark);
            border: 1px solid #ccc;
        }

        /* --- 结果页面 --- */
        .score-summary {
            display: grid;
            /* 允许卡片在手机上更窄 */
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 16px;
            margin-bottom: var(--spacing-xl);
        }

        .score-card {
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            background-color: var(--light-green);
        }
        
        /* 针对总分卡片做特殊处理，让它在手机可能独占一行 */
        .score-card:first-child {
            grid-column: 1 / -1;
            background-color: #E8F4FF;
        }

        .score-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--dark-green);
            line-height: 1;
            margin-bottom: 8px;
        }
        
        .score-card:first-child .score-value {
            color: #007AFF;
        }

        .score-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .score-description {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .radar-chart-container {
            margin: var(--spacing-lg) 0;
            padding: 10px; /* 减小内边距 */
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .chart-wrapper {
            position: relative;
            height: 350px; /* 默认高度 */
            width: 100%;
        }

        /* 因子列表样式 */
        .factor-item {
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 12px;
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .factor-name-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .severity-tag {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
        }
        
        .severity-normal { background-color: #34C759; }
        .severity-mild { background-color: #FFCC00; color: #333; }
        .severity-moderate { background-color: #FF9500; }
        .severity-severe { background-color: #FF3B30; }

        /* --- 响应式媒体查询 (针对手机端) --- */
        @media (max-width: 768px) {
            /* 头部变为垂直排列 */
            header {
                flex-direction: column;
                gap: 16px;
                padding-bottom: 16px;
            }

            nav ul {
                gap: 24px;
                width: 100%;
                justify-content: center;
                padding: 0;
            }

            /* 首页适配 */
            .features {
                grid-template-columns: 1fr; /* 强制单列 */
            }

            /* 测试页适配 */
            .options-container {
                grid-template-columns: 1fr; /* 选项变为单列大按钮，更容易点击 */
            }
            
            .option {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 14px 20px;
                text-align: left;
            }
            
            .option-value {
                order: 2; /* 分数放右边 */
                margin-bottom: 0;
            }

            /* 结果页适配 */
            .score-summary {
                grid-template-columns: 1fr 1fr; /* 两列 */
            }
            
            .chart-wrapper {
                height: 280px; /* 手机上调低图表高度 */
            }

            .actions {
                flex-direction: column; /* 按钮垂直排列 */
                gap: 12px;
            }
            
            .btn {
                width: 100%; /* 按钮全宽 */
            }

            /* 隐藏不必要的打印按钮在手机上 */
            #print-btn {
                display: none;
            }
            
            .footer-links {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">
            <div class="logo-icon">S</div>
            <div class="logo-text">SCL-90 量表</div>
        </div>
        <nav>
            <ul>
                <li><a href="#" class="nav-link active" data-page="home">首页</a></li>
                <li><a href="#" class="nav-link" data-page="test">测试</a></li>
                <li><a href="#" class="nav-link" data-page="results">结果</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="home" class="page active">
            <div class="hero">
                <h1>心理健康自评量表</h1>
                <p>90项症状清单 (SCL-90) 是世界上最著名的心理健康测查工具之一。请根据最近一周的实际感受进行评估。</p>
                <a href="#" class="btn start-test-btn">开始评估 <i class="fas fa-arrow-right" style="margin-left:8px;"></i></a>
            </div>

            <div class="features">
                <div class="feature-card">
                    <i class="fas fa-clipboard-check" style="font-size:24px; color:var(--primary-green); margin-bottom:12px;"></i>
                    <h3>专业权威</h3>
                    <p style="font-size:14px; color:#666;">广泛应用于医院与心理咨询机构，信效度高。</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-shield-alt" style="font-size:24px; color:var(--primary-green); margin-bottom:12px;"></i>
                    <h3>隐私安全</h3>
                    <p style="font-size:14px; color:#666;">纯本地计算，数据不上传服务器，完全匿名。</p>
                </div>
            </div>
            
             <div class="feature-card" style="margin-top: var(--spacing-lg);">
                <h3>如何计分？</h3>
                <ul style="margin-top:10px; padding-left:20px; font-size:14px; color:#555; line-height:1.8;">
                    <li><strong>1分 - 没有：</strong> 自觉无该项症状</li>
                    <li><strong>2分 - 很轻：</strong> 偶尔有，不影响生活</li>
                    <li><strong>3分 - 中等：</strong> 症状明显，有轻微影响</li>
                    <li><strong>4分 - 偏重：</strong> 常有该症状，程度较重</li>
                    <li><strong>5分 - 严重：</strong> 频度和强度都十分严重</li>
                </ul>
            </div>
        </section>

        <section id="test" class="page">
            <div class="test-header">
                <div class="progress-container">
                    <div class="progress-text">
                        <span>进度: <span id="current-question">1</span>/90</span>
                        <span id="progress-percent">1%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
            </div>

            <div class="question-container">
                <div class="question-number">第 <span id="question-num">1</span> 题</div>
                <div class="question-text" id="question-text">头痛</div>

                <div class="options-container" id="options-container">
                    </div>
            </div>
            
            <div class="test-navigation">
                <button class="btn btn-secondary" id="prev-btn" style="flex:1;">上一题</button>
                <button class="btn" id="next-btn" style="flex:2;">下一题</button>
                <button class="btn" id="submit-btn" style="display: none; flex:2; background-color: var(--dark-green);">查看报告</button>
            </div>
        </section>

        <section id="results" class="page">
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="font-size:24px;">评估报告</h2>
                <p style="font-size:14px; color:#888;">测试时间: <span id="test-date"></span></p>
            </div>

            <div class="score-summary">
                <div class="score-card">
                    <div class="score-value" id="total-score">0</div>
                    <div class="score-label">总分</div>
                    <div class="score-description">总分超过160分需关注</div>
                </div>
                <div class="score-card">
                    <div class="score-value" id="average-score">0.0</div>
                    <div class="score-label">总均分</div>
                </div>
                <div class="score-card">
                    <div class="score-value" id="positive-items">0</div>
                    <div class="score-label">阳性项目</div>
                    <div class="score-description">得分≥2的项目数</div>
                </div>
            </div>

            <div class="radar-chart-container">
                <div class="chart-header" style="margin-bottom:10px;">
                    <h3 style="font-size:18px;">因子分布图</h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="factorRadarChart"></canvas>
                </div>
            </div>

            <div class="factor-results">
                <h3 style="margin: 24px 0 16px; font-size:18px;">详细因子解读</h3>
                <div class="factors-column" id="factors-column">
                    </div>
            </div>

            <div class="feature-card" style="margin-top:20px; background-color:#F0F8FF; border:none; border-left:4px solid #007AFF;">
                <h4 style="color:#007AFF; margin-bottom:8px;">综合评价</h4>
                <p id="personal-interpretation" style="font-size:15px; text-align:justify;"></p>
            </div>

            <div class="actions">
                <button class="btn" id="retake-btn">重新测试</button>
                <button class="btn btn-secondary" id="print-btn">打印报告</button>
                <button class="btn btn-secondary" id="home-btn">返回首页</button>
            </div>
        </section>
    </main>

    <footer style="text-align:center; margin-top:40px; color:#999; font-size:12px;">
        <p>本测试仅供参考，不作为医学诊断依据。</p>
        <p>&copy; 2023 SCL-90 Assessment</p>
    </footer>

    <script>
        // SCL-90 题目数据 (保持不变)
        const scl90Questions = [
            "头痛", "神经过敏，心中不踏实", "头脑中有不必要的想法或字句盘旋", "头晕或晕倒", "对异性的兴趣减退", 
            "对旁人责备求全", "感到别人能控制您的思想", "责怪别人制造麻烦", "忘性大", "担心自己的衣饰整齐及仪态的端正", 
            "容易烦恼和激动", "胸痛", "害怕空旷的场所或街道", "感到自己的精力下降，活动减慢", "想结束自己的生命", 
            "听到旁人听不到的声音", "发抖", "感到大多数人都不可信任", "胃口不好", "容易哭泣", 
            "同异性相处时感到害羞不自在", "感到受骗，中了圈套或有人想抓住您", "无缘无故地突然感到害怕", "自己不能控制地大发脾气", "怕单独出门", 
            "经常责怪自己", "腰痛", "感到难以完成任务", "感到孤独", "感到苦闷", 
            "过分担忧", "对事物不感兴趣", "感到害怕", "您的感情容易受到伤害", "旁人能知道您的私下想法", 
            "感到别人不理解您、不同情您", "感到人们对您不友好，不喜欢您", "做事必须做得很慢以保证做得正确", "心跳得很厉害", "恶心或胃部不舒服", 
            "感到比不上他人", "肌肉酸痛", "感到有人在监视您、谈论您", "难以入睡", "做事必须反复检查", 
            "难以做出决定", "怕乘电车、公共汽车、地铁或火车", "呼吸有困难", "一阵阵发冷或发热", "因为感到害怕而避开某些东西、场合或活动", 
            "脑子变空了", "身体发麻或刺痛", "喉咙有梗塞感", "感到前途没有希望", "不能集中注意力", 
            "感到身体的某一部分软弱无力", "感到紧张或容易紧张", "感到手或脚发重", "想到死亡的事", "吃得太多", 
            "当别人看着您或谈论您时感到不自在", "有一些不属于您自己的想法", "有想打人或伤害他人的冲动", "醒得太早", "必须反复洗手、点数", 
            "睡得不稳不深", "有想摔坏或破坏东西的想法", "有一些别人没有的想法", "感到对别人神经过敏", "在商店或电影院等人多的地方感到不自在", 
            "感到任何事情都很困难", "一阵阵恐惧或惊恐", "感到公共场合吃东西很不舒服", "经常与人争论", "单独一人时神经很紧张", 
            "别人对您的成绩没有做出恰当的评价", "即使和别人在一起也感到孤单", "感到坐立不安心神不定", "感到自己没有什么价值", "感到熟悉的东西变成陌生或不像是真的", 
            "大叫或摔东西", "害怕会在公共场合晕倒", "感到别人想占您的便宜", "为一些有关性的想法而很苦恼", "您认为应该因为自己的过错而受到惩罚", 
            "感到要很快把事情做完", "感到自己的身体有严重问题", "从未感到和其他人很亲近", "感到自己有罪", "感到自己的脑子有毛病"
        ];

        // 因子定义
        const scl90Factors = [
            { name: "躯体化", items: [1, 4, 12, 27, 40, 42, 48, 49, 52, 53, 56, 58], desc: "身体不适感" },
            { name: "强迫", items: [3, 9, 10, 28, 38, 45, 46, 51, 55, 65], desc: "无法摆脱的冲动" },
            { name: "人际敏感", items: [6, 21, 34, 36, 37, 41, 61, 69, 73], desc: "自卑与不自在" },
            { name: "抑郁", items: [5, 14, 15, 20, 22, 26, 29, 30, 31, 32, 54, 71, 79], desc: "苦闷与缺乏动力" },
            { name: "焦虑", items: [2, 17, 23, 33, 39, 57, 72, 78, 80, 86], desc: "神经过敏与惊恐" },
            { name: "敌对", items: [11, 24, 63, 67, 74, 81], desc: "易激惹与争论" },
            { name: "恐怖", items: [13, 25, 47, 50, 70, 75, 82], desc: "场所与社交恐惧" },
            { name: "偏执", items: [8, 18, 43, 68, 76, 83], desc: "猜疑与敌意" },
            { name: "精神病性", items: [7, 16, 35, 62, 77, 84, 85, 87, 88, 89, 90], desc: "幻觉与被动体验" },
            { name: "其他", items: [19, 44, 59, 60, 64, 66], desc: "睡眠与饮食" }
        ];

        let userAnswers = new Array(90).fill(0);
        let currentQuestion = 0;
        let radarChart = null;

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 设置日期
            const today = new Date();
            if(document.getElementById('test-date')) {
                document.getElementById('test-date').textContent = today.toLocaleDateString();
            }

            // 绑定页面切换
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchPage(this.getAttribute('data-page'));
                });
            });

            document.querySelector('.start-test-btn').addEventListener('click', (e) => {
                e.preventDefault();
                switchPage('test');
            });

            // 绑定结果页按钮
            document.getElementById('retake-btn').addEventListener('click', () => {
                if(confirm('确定要重新开始测试吗？当前结果将清空。')) {
                    resetTest();
                    switchPage('test');
                }
            });

            document.getElementById('home-btn').addEventListener('click', () => switchPage('home'));
            document.getElementById('print-btn').addEventListener('click', () => window.print());

            initTestPage();
        });

        // 切换页面
        function switchPage(pageId) {
            // 滚动到顶部
            window.scrollTo(0,0);
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if(link.getAttribute('data-page') === pageId) link.classList.add('active');
            });

            if (pageId === 'results') calculateResults();
        }

        // 初始化测试逻辑
        function initTestPage() {
            const optionsData = [
                { val: 1, text: '没有' }, { val: 2, text: '很轻' },
                { val: 3, text: '中等' }, { val: 4, text: '偏重' }, { val: 5, text: '严重' }
            ];

            const container = document.getElementById('options-container');
            container.innerHTML = '';

            optionsData.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'option';
                div.dataset.value = opt.val;
                div.innerHTML = `<div class="option-text">${opt.text}</div><div class="option-value">${opt.val}</div>`;
                
                div.addEventListener('click', function() {
                    userAnswers[currentQuestion] = parseInt(this.dataset.value);
                    renderOptionsState(); // 更新视觉选中状态
                    
                    // 自动跳转优化：手机上点击选项后自动延迟跳转下一题，体验更好
                    setTimeout(() => {
                        goToNextQuestion();
                    }, 250);
                });
                container.appendChild(div);
            });

            document.getElementById('prev-btn').addEventListener('click', goToPrevQuestion);
            document.getElementById('next-btn').addEventListener('click', goToNextQuestion);
            document.getElementById('submit-btn').addEventListener('click', showResultsCheck);
            
            showQuestion(0);
        }

        function showQuestion(index) {
            currentQuestion = index;
            document.getElementById('question-num').textContent = index + 1;
            document.getElementById('question-text').textContent = scl90Questions[index];
            document.getElementById('current-question').textContent = index + 1;
            
            const percent = Math.round(((index + 1) / 90) * 100);
            document.getElementById('progress-percent').textContent = percent + '%';
            document.getElementById('progress-fill').style.width = percent + '%';

            renderOptionsState();
            updateNavButtons();
        }

        function renderOptionsState() {
            const currentVal = userAnswers[currentQuestion];
            document.querySelectorAll('.option').forEach(el => {
                if (parseInt(el.dataset.value) === currentVal) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');

            prevBtn.disabled = currentQuestion === 0;
            prevBtn.style.opacity = currentQuestion === 0 ? '0.5' : '1';

            if (currentQuestion === 89) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
                // 只有答完当前题才允许提交
                submitBtn.disabled = userAnswers[89] === 0;
                submitBtn.style.opacity = userAnswers[89] === 0 ? '0.5' : '1';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
        }

        function goToNextQuestion() {
            if (currentQuestion < 89) {
                // 如果当前没答，提示一下或允许跳过？一般量表不允许跳过，这里强制选择
                if (userAnswers[currentQuestion] === 0) {
                    // 可以加一个震动反馈或提示，这里简单处理不做跳转
                    return; 
                }
                showQuestion(currentQuestion + 1);
            }
        }

        function goToPrevQuestion() {
            if (currentQuestion > 0) showQuestion(currentQuestion - 1);
        }

        function showResultsCheck() {
            // 再次检查是否有未答题目
            const unanswered = userAnswers.indexOf(0);
            if (unanswered !== -1) {
                alert(`第 ${unanswered + 1} 题尚未作答，请补充完整。`);
                showQuestion(unanswered);
                return;
            }
            switchPage('results');
        }

        function resetTest() {
            userAnswers.fill(0);
            currentQuestion = 0;
            showQuestion(0);
        }

        function calculateResults() {
            const totalScore = userAnswers.reduce((a, b) => a + b, 0);
            const positiveItems = userAnswers.filter(v => v >= 2).length;
            const avgScore = (totalScore / 90).toFixed(2);

            document.getElementById('total-score').textContent = totalScore;
            document.getElementById('average-score').textContent = avgScore;
            document.getElementById('positive-items').textContent = positiveItems;

            // 因子分计算
            const factorsColumn = document.getElementById('factors-column');
            factorsColumn.innerHTML = '';
            
            const radarLabels = [];
            const radarData = [];

            scl90Factors.forEach((f, idx) => {
                let sum = 0;
                f.items.forEach(i => sum += userAnswers[i-1]);
                let score = (sum / f.items.length).toFixed(2);
                
                // 收集数据给雷达图（不包含"其他"）
                if (f.name !== "其他") {
                    radarLabels.push(f.name);
                    radarData.push(score);
                }

                let severityClass = 'severity-normal';
                let severityText = '正常';
                if (score >= 3) { severityClass = 'severity-moderate'; severityText = '中重度'; }
                else if (score >= 2) { severityClass = 'severity-mild'; severityText = '轻度'; }

                const div = document.createElement('div');
                div.className = 'factor-item';
                div.innerHTML = `
                    <div class="factor-header">
                        <div class="factor-name-container">
                            <span style="font-weight:600;">${f.name}</span>
                            <span class="severity-tag ${severityClass}">${severityText}</span>
                        </div>
                        <span style="font-weight:bold; color:var(--dark-green);">${score}</span>
                    </div>
                    <div style="font-size:12px; color:#888; margin-top:4px;">${f.desc}</div>
                    <div style="height:6px; background:#eee; border-radius:3px; margin-top:8px; overflow:hidden;">
                        <div style="width:${Math.min(score*20, 100)}%; height:100%; background-color:${score>=2 ? '#FF9500':'#34C759'};"></div>
                    </div>
                `;
                factorsColumn.appendChild(div);
            });

            updateRadarChart(radarLabels, radarData);
            updateInterpretation(totalScore, avgScore);
        }

        function updateRadarChart(labels, data) {
            const ctx = document.getElementById('factorRadarChart').getContext('2d');
            
            // 移动端字体调整
            const isMobile = window.innerWidth < 768;
            const fontSize = isMobile ? 10 : 14;

            if (radarChart) radarChart.destroy();

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '您的得分',
                        data: data,
                        backgroundColor: 'rgba(52, 199, 89, 0.2)',
                        borderColor: 'rgba(52, 199, 89, 1)',
                        pointBackgroundColor: 'rgba(52, 199, 89, 1)',
                        borderWidth: 2
                    }, {
                        label: '参考界限(2分)',
                        data: Array(labels.length).fill(2),
                        borderColor: 'rgba(255, 59, 48, 0.5)',
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(0,0,0,0.05)' },
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            pointLabels: {
                                font: { size: fontSize },
                                color: '#333'
                            },
                            suggestedMin: 0,
                            suggestedMax: 5,
                            ticks: {
                                stepSize: 1,
                                backdropColor: 'transparent',
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: isMobile ? 'bottom' : 'top',
                            labels: { boxWidth: 10, padding: 10, font: {size: 12} }
                        }
                    }
                }
            });
        }

        function updateInterpretation(total, avg) {
            const el = document.getElementById('personal-interpretation');
            let text = "";
            
            if (total > 160 || avg >= 2) {
                text = `您的总分为 <strong>${total}</strong>，平均分 <strong>${avg}</strong>。结果显示您近期可能存在一定的心理压力或困扰。如果某些因子分超过3分，建议您针对该方面进行自我调节，如保持规律作息、适当运动。若感到持续痛苦且影响生活，建议寻求专业心理咨询师的帮助。`;
                el.parentElement.style.borderLeftColor = "#FF9500";
                el.previousElementSibling.style.color = "#FF9500";
            } else {
                text = `您的总分为 <strong>${total}</strong>，平均分 <strong>${avg}</strong>。您的心理健康状况总体良好，处于正常范围。生活中偶尔的情绪波动是正常的，请继续保持积极的生活态度。`;
                el.parentElement.style.borderLeftColor = "#34C759";
                el.previousElementSibling.style.color = "#34C759";
            }
            el.innerHTML = text;
        }
    </script>
</body>
</html>
